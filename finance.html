<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>Ma√Ætre Candice ROVERA - Gestion Financi√®re</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/finance.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="finance-page">
  <div class="theme-buttons">
    <button id="refreshPageBtn" class="theme-button">
        <span id="refreshIcon">üîÑ</span>
        <span>Actualiser</span>
    </button>
    <button id="themeToggle" class="theme-button">
        <span id="themeIcon">üåû</span>
        <span id="themeText">Mode sombre</span>
    </button>
  </div>
  
  <header>
    <div class="header-content">
        <img src="logo_candice.png" alt="Logo Candice ROVERA" class="header-logo">
        <h1>Gestion financi√®re</h1>
    </div>
    <div class="header-actions">
        <button id="backToHomeBtn" class="nav-button">Retour √† l'accueil</button>
    </div>
  </header>

    <div class="finance-dashboard">
        <!-- Section statistiques -->
        <div class="stats-section">
            <h2>Statistiques factures</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-title">Factures envoy√©es</div>
                    <div class="stat-value" id="invoicesSentCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Factures pay√©es</div>
                    <div class="stat-value" id="invoicesPaidCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Total HT envoy√©</div>
                    <div class="stat-value" id="invoicesSentHT">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Total TTC envoy√©</div>
                    <div class="stat-value" id="invoicesSentTTC">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Total HT pay√©</div>
                    <div class="stat-value" id="invoicesPaidHT">0,00 ‚Ç¨</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">Total TTC pay√©</div>
                    <div class="stat-value" id="invoicesPaidTTC">0,00 ‚Ç¨</div>
                </div>
            </div>
        </div>

        <!-- Coordonn√©es du cabinet -->
        <div class="cabinet-info">
            <div class="lawyer-details">
                <h3>Ma√Ætre Candice ROVERA</h3>
                <p>Avocate au Barreau de Paris</p>
                <p>SIRET : 98302483700020</p>
                <p>TVA Intracommunautaire : FR13983024837</p>
                <button class="secondary-button" onclick="openRibSettings()">G√©rer le RIB</button>
            </div>
        </div>

        <!-- R√©sum√© financier -->
        <div class="finance-summary">
            <div class="stat-card">
                <h3>Chiffre d'affaires HT de l'ann√©e en cours</h3>
                <div id="totalHT" class="stat-value">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <h3>TVA (20%)</h3>
                <div id="totalTVA" class="stat-value">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <h3>Total TTC</h3>
                <div id="totalTTC" class="stat-value">0 ‚Ç¨</div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="charts-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
            <!-- Premier graphique (√† gauche) -->
            <div class="chart-section" style="flex: 1; min-width: 45%;">
                <h3>Evolution du CA mensuel</h3>
                <div class="chart-container" style="position: relative; height: 350px; width: 100%;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <!-- Deuxi√®me graphique (√† droite) -->
            <div class="chart-section" style="flex: 1; min-width: 45%;">
                <h3>R√©partition par type de dossier</h3>
                <div class="chart-container" style="position: relative; height: 350px; width: 100%;">
                    <canvas id="dossiersChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Espace de s√©paration avant la section des factures -->
        <div style="margin-top: 40px;"></div>

        <!-- Gestion des factures -->
        <div class="invoices-section">
            <h2>Gestion des factures</h2>
            <button id="createInvoiceBtn" class="primary-button">Cr√©er une nouvelle facture</button>
            
            <!-- Liste des factures -->
            <div class="invoices-list">
                <table id="invoicesTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="number">N¬∞ Facture</th>
                            <th class="sortable" data-sort="client">Client</th>
                            <th class="sortable" data-sort="description">Description</th>
                            <th class="sortable" data-sort="date">Date</th>
                            <th class="sortable" data-sort="totalHT">Montant HT</th>
                            <th class="sortable" data-sort="totalTTC">Total TTC</th>
                            <th class="sortable" data-sort="status">Statut</th>
                            <th style="text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Template de facture -->
        <div id="invoiceTemplate" style="display: none;">
            <div class="invoice-header">
                <div class="lawyer-info">
                    <h2>Ma√Ætre Candice ROVERA</h2>
                    <p>Avocate au Barreau de Paris</p>
                    <p>[Adresse du cabinet]</p>
                    <p>T√©l: [Num√©ro de t√©l√©phone]</p>
                    <p>Email: [Email professionnel]</p>
                    <p>SIRET : 98302483700020</p>
                    <p>TVA Intracommunautaire : FR13983024837</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour cr√©er/modifier une facture -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <button class="close-modal">√ó</button>
            <h2>Cr√©ation de facture</h2>
            <form id="invoiceForm">
                <!-- En-t√™te de facture -->
                <div class="form-group">
                    <label>Client :</label>
                    <select id="clientSelect" required></select>
                </div>

                <!-- Tableau des prestations -->
                <div class="form-group">
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Description de la prestation</th>
                                <th>Montant HT</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prestationsContainer">
                            <tr class="prestation-item">
                                <td><input type="text" class="prestation-desc" placeholder="Description" required></td>
                                <td><input type="number" class="prestation-amount" placeholder="0.00" step="0.01" required onchange="updateTotals()"></td>
                                <td><button type="button" class="remove-row" onclick="removeRow(this)">√ó</button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3">
                                    <button type="button" class="add-row">+ Ajouter une ligne</button>
                                </td>
                            </tr>
                            <tr class="totals">
                                <td>Total HT</td>
                                <td id="invoiceTotalHT">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                            <tr class="totals">
                                <td>TVA (20%)</td>
                                <td id="invoiceTVA">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                            <tr class="totals">
                                <td>Total TTC</td>
                                <td id="invoiceTotalTTC">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="button-group">
                    <button type="submit" class="primary-button">G√©n√©rer la facture</button>
                    <button type="button" class="secondary-button" onclick="closeModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <!-- Espace r√©serv√© pour des boutons futurs si besoin -->
    </div>

    <!-- Ajouter une nouvelle modale pour g√©rer le RIB -->

    <div id="ribSettingsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="document.getElementById('ribSettingsModal').style.display='none'">√ó</button>
            <h2>Gestion du RIB</h2>
            
            <div class="form-group">
                <label>RIB actuel:</label>
                <div id="currentRibInfo">
                    <span id="currentRibPath"></span>
                    <button type="button" class="secondary-button" onclick="previewRib()">Aper√ßu</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="newRibFile">Changer le RIB:</label>
                <input type="file" id="newRibFile" accept=".pdf,.jpg,.jpeg,.png">
            </div>
            
            <div class="button-group">
                <button type="button" class="primary-button" onclick="updateRib()">Enregistrer</button>
                <button type="button" class="secondary-button" onclick="document.getElementById('ribSettingsModal').style.display='none'">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Gardez uniquement cette modale √† la fin du document -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeEmailModal()">√ó</button>
            <h2>Envoi de facture par email</h2>
            <form id="emailForm">
                <input type="hidden" id="invoiceNumberForEmail">
                
                <div class="form-group">
                    <label for="emailFrom">De :</label>
                    <input type="email" id="emailFrom" value="dhllaky@gmail.com" readonly>
                </div>
                
                <div class="form-group">
                    <label for="emailTo">√Ä :</label>
                    <input type="email" id="emailTo" required>
                </div>
                
                <div class="form-group">
                    <label for="emailSubject">Objet :</label>
                    <input type="text" id="emailSubject" value="Facture de Me Candice ROVERA">
                </div>
                
                <div class="form-group">
                    <label for="emailMessage">Message :</label>
                    <textarea id="emailMessage" rows="8">Bonjour,

Veuillez trouver ci-joint votre facture.

Cordialement,
Me Candice ROVERA
Avocate au Barreau de Paris</textarea>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="attachPDF" checked>
                    <label for="attachPDF">Joindre la facture en PDF</label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeEmailModal()">Annuler</button>
                    <button type="submit" class="btn-primary">Envoyer</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        Ma√Ætre Candice ROVERA - Avocate au Barreau de Paris
    </footer>

    <!-- Ajouter avant les autres scripts pour s'assurer que la config est charg√©e en premier -->

    <script src="js/config.js"></script>
    <script src="js/email-config.js"></script>
    <script src="js/utils.js"></script>
    <!-- Autres scripts... -->

    <!-- Ajouter juste avant les autres scripts -->
    <script>
    // Pr√©parer le module remote
    try {
        window.require = require;
    } catch (e) {
        console.warn('Module require non disponible. Mode navigateur d√©tect√©.');
    }
    </script>

    <!-- Ordre de chargement correct -->
    <script src="js/utils.js"></script>
    <script src="js/path-manager.js"></script>
    <script src="js/window-manager.js"></script>
    <script src="js/modal-manager.js"></script>
    <script src="js/client-manager.js"></script>
    <script src="js/invoice-manager.js"></script>
    <script src="js/email-manager.js"></script>
    <script src="js/chart-manager.js"></script>
    <script src="js/finance-stats.js"></script> <!-- Nouveau fichier -->
    <script src="js/finance-core.js"></script>
    <script>
    // Script de d√©marrage pour s'assurer que tout fonctionne
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page finance charg√©e - script de secours');
        
        // V√©rifier que les variables globales sont d√©finies
        window.clients = window.clients || [];
        window.invoices = window.invoices || [];
        
        // AJOUT CRUCIAL: Charger les factures au d√©marrage
        if (typeof loadInvoices === 'function') {
            console.log('Chargement automatique des factures...');
            loadInvoices();
        } else {
            console.error('Fonction loadInvoices non disponible!');
        }
        
        // S'assurer que les clients sont charg√©s
        if (typeof loadClients === 'function') {
            loadClients();
        }
        
        // AJOUT: Mettre √† jour l'interface apr√®s un court d√©lai
        setTimeout(function() {
            if (typeof updateInvoicesList === 'function') {
                console.log('Mise √† jour de la liste des factures apr√®s chargement');
                updateInvoicesList();
            }
            
            // IMPORTANT: Forcer la mise √† jour des statistiques
            if (typeof updateInvoiceStats === 'function') {
                console.log('Mise √† jour des statistiques financi√®res');
                updateInvoiceStats();
            } else {
                console.error("Fonction updateInvoiceStats non disponible");
            }
            
            // AJOUT: Mettre √† jour √©galement les statistiques et graphiques
            if (typeof updateFinancialStats === 'function') {
                console.log('Mise √† jour des statistiques financi√®res');
                updateFinancialStats();
            }
            
            if (typeof updateCharts === 'function') {
                console.log('Mise √† jour des graphiques');
                updateCharts();
            }
        }, 1000); // Augmenter l√©g√®rement le d√©lai
        
        // Initialiser le tri par colonne
        if (typeof initSortableTable === 'function') {
            console.log('Initialisation du tri par colonne');
            initSortableTable();
        }
        
        // Attacher manuellement l'√©v√©nement au bouton
        const createBtn = document.getElementById('createInvoiceBtn');
        if (createBtn) {
            console.log('Bouton trouv√©, attachement de l\'√©v√©nement');
            createBtn.addEventListener('click', function() {
                console.log('Bouton cliqu√©');
                // Appeler la fonction de cr√©ation de facture
                if (typeof openInvoiceModal === 'function') {
                    openInvoiceModal();
                } else if (typeof recreateInvoiceModal === 'function') {
                    recreateInvoiceModal();
                    const modal = document.getElementById('invoiceModal');
                    if (modal) modal.style.display = 'flex';
                } else {
                    console.error('Aucune fonction de cr√©ation de facture trouv√©e');
                    alert('Fonction de cr√©ation de facture non disponible. Veuillez recharger la page.');
                }
            });
        } else {
            console.error('Bouton createInvoiceBtn non trouv√© dans le DOM');
        }
    });

    // Fonction de test pour le syst√®me de fichiers
    function testFileIO() {
        console.log('=== TEST DU SYST√àME DE FICHIERS ===');
        
        try {
            const fs = window.fs;
            const path = window.path;
            
            if (!fs || !path) {
                console.error('Modules fs ou path non disponibles');
                alert('Modules fs ou path non disponibles');
                return;
            }
            
            // Lister les fichiers √† la racine
            const rootPath = path.join(__dirname);
            console.log('Chemin racine:', rootPath);
            
            const files = fs.readdirSync(rootPath);
            console.log('Fichiers √† la racine:', files);
            
            // Tenter d'√©crire un fichier de test
            const testPath = path.join(rootPath, 'test-io.json');
            fs.writeFileSync(testPath, JSON.stringify({test: 'donn√©es de test', timestamp: new Date().toISOString()}));
            console.log('Fichier test-io.json cr√©√© avec succ√®s');
            
            // V√©rifier que le fichier invoices.json existe
            const invoicesPath = window.invoicesPath;
            if (fs.existsSync(invoicesPath)) {
                console.log('Le fichier invoices.json existe au chemin:', invoicesPath);
                // Lire son contenu
                const content = fs.readFileSync(invoicesPath, 'utf8');
                console.log('Taille du contenu:', content ? content.length : 0);
                
                if (content) {
                    try {
                        const data = JSON.parse(content);
                        console.log(`Le fichier contient ${data.length} factures`);
                        
                        // Essayer de sauvegarder le m√™me contenu
                        fs.writeFileSync(invoicesPath, JSON.stringify(data, null, 2));
                        console.log('R√©√©criture r√©ussie');
                        
                        alert(`Test r√©ussi! ${data.length} factures lues et sauvegard√©es.`);
                    } catch (e) {
                        console.error('Erreur lors du parsing JSON:', e);
                        alert('Erreur lors du parsing JSON: ' + e.message);
                    }
                } else {
                    console.log('Le fichier existe mais est vide');
                    fs.writeFileSync(invoicesPath, '[]');
                    alert('Le fichier invoices.json √©tait vide. Un tableau vide a √©t√© cr√©√©.');
                }
            } else {
                console.log('Le fichier invoices.json n\'existe pas, cr√©ation...');
                fs.writeFileSync(invoicesPath, '[]');
                alert('Le fichier invoices.json a √©t√© cr√©√© avec un tableau vide.');
            }
        } catch (error) {
            console.error('Erreur lors du test:', error);
            alert('Erreur: ' + error.message);
        }
    }

    function testSaveLoad() {
      try {
        // 1. Cr√©er facture test
        const testInvoice = {number: 'TEST-' + Date.now(), date: new Date().toISOString()};
        
        // 2. Sauvegarder
        window.invoices = [testInvoice];
        const saveOk = saveInvoicesToFile();
        
        // 3. Recharger
        window.invoices = [];
        loadInvoices();
        
        // 4. V√©rifier
        const found = window.invoices.find(i => i.number === testInvoice.number);
        
        alert(found ? 'Test r√©ussi! Sauvegarde fonctionnelle.' : '√âchec du test!');
        
        // Nettoyer
        window.invoices = window.invoices.filter(i => !i.number.startsWith('TEST-'));
        saveInvoicesToFile();
      } catch (e) {
        alert('Erreur: ' + e.message);
      }
    }

    // Ajouter cette fonction dans finance.html ou dans invoice-manager.js
    function diagnoseAndRepairInvoiceSystem() {
      console.log('=== DIAGNOSTIC ET R√âPARATION DU SYST√àME DE FACTURES ===');
      
      try {
        // 1. V√©rifier le fichier
        const fs = require('fs');
        const invoicesPath = window.invoicesPath;
        
        console.log('Chemin du fichier:', invoicesPath);
        
        if (fs.existsSync(invoicesPath)) {
          console.log('Fichier trouv√©');
          
          // Lire le contenu
          const content = fs.readFileSync(invoicesPath, 'utf8');
          console.log(`Taille du contenu: ${content.length} caract√®res`);
          
          // Parser le JSON
          try {
            const data = JSON.parse(content);
            console.log(`Le fichier contient ${data.length} factures`);
            
            // 2. Comparer avec les factures en m√©moire
            console.log(`Factures en m√©moire: ${window.invoices ? window.invoices.length : 'undefined'}`);
            
            // 3. Forcer le chargement depuis le fichier
            window.invoices = data;
            
            // 4. Mettre √† jour l'interface
            if (typeof updateInvoicesList === 'function') {
              updateInvoicesList();
            }
            
            alert(`R√©paration termin√©e! ${data.length} factures charg√©es.`);
          } catch (e) {
            console.error('Erreur de parsing:', e);
            alert('Erreur de parsing JSON: ' + e.message);
          }
        } else {
          alert('Fichier non trouv√©: ' + invoicesPath);
        }
      } catch (e) {
        alert('Erreur: ' + e.message);
      }
    }
    </script>

    <script>
    // Gestionnaire d'√©v√©nement pour le bouton "Retour √† l'accueil"
    document.addEventListener('DOMContentLoaded', function() {
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', function() {
                window.location.href = 'index.html';
            });
        }
    });
    </script>
    <script src="theme.js"></script>

    <!-- Ajouter ce script juste avant la fermeture de </body> -->

    <script>
    // Solution radicale pour corriger les boutons dans les modales
    function forceButtonsCorrection() {
        console.log("üõ†Ô∏è Application d'une solution radicale pour les boutons...");
        
        // Cibler toutes les modales ouvertes
        document.querySelectorAll('.modal:not([style*="display: none"])').forEach(modal => {
            // Trouver les boutons, peu importe o√π ils sont
            const cancelBtn = modal.querySelector('button:contains("Annuler"), .btn-secondary, .cancel-btn');
            const primaryBtn = modal.querySelector('button:contains("G√©n√©rer"), .btn-primary, button[type="submit"]');
            
            if (cancelBtn && primaryBtn) {
                console.log("üîç Boutons trouv√©s, application de la correction radicale");
                
                // 1. Cr√©er un nouveau conteneur pour les boutons
                let buttonContainer = modal.querySelector('.fixed-button-container');
                if (!buttonContainer) {
                    buttonContainer = document.createElement('div');
                    buttonContainer.className = 'fixed-button-container';
                    
                    // Appliquer un style direct au conteneur
                    buttonContainer.style.position = 'absolute';
                    buttonContainer.style.bottom = '20px';
                    buttonContainer.style.right = '20px';
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.flexDirection = 'row';
                    buttonContainer.style.gap = '10px';
                    buttonContainer.style.zIndex = '9999';
                    
                    // Ajouter au conteneur modal
                    modal.querySelector('.modal-content').appendChild(buttonContainer);
                }
                
                // 2. D√©tacher les boutons de leur position actuelle et les ajouter √† notre conteneur
                if (cancelBtn.parentNode) {
                    try { cancelBtn.parentNode.removeChild(cancelBtn); } catch(e) {}
                }
                
                if (primaryBtn.parentNode) {
                    try { primaryBtn.parentNode.removeChild(primaryBtn); } catch(e) {}
                }
                
                // 3. R√©initialiser tous les styles des boutons
                cancelBtn.style = '';
                primaryBtn.style = '';
                
                // 4. Appliquer nos styles directs
                const buttonStyles = {
                    padding: '8px 16px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    border: 'none',
                    backgroundColor: 'var(--primary-color)',
                    color: 'white',
                    fontWeight: '500',
                    margin: '0 5px'
                };
                
                Object.assign(cancelBtn.style, buttonStyles);
                Object.assign(primaryBtn.style, buttonStyles);
                
                // 5. Ajouter les boutons dans le bon ordre (invers√©)
                buttonContainer.innerHTML = '';
                buttonContainer.appendChild(cancelBtn);   // D'abord le bouton Annuler
                buttonContainer.appendChild(primaryBtn);  // Puis le bouton G√©n√©rer
                
                console.log("‚úÖ Boutons repositionn√©s avec succ√®s");
            }
        });
    }

    // Ex√©cuter la correction √† l'ouverture des modales
    document.addEventListener('click', function(e) {
        // D√©tecter les clics sur les √©l√©ments qui ouvrent des modales
        if (e.target.getAttribute('data-toggle') === 'modal' || 
            e.target.closest('[data-toggle="modal"]')) {
            
            // Ex√©cuter notre correction apr√®s un court d√©lai
            setTimeout(forceButtonsCorrection, 100);
            setTimeout(forceButtonsCorrection, 300);
        }
    });

    // √âgalement lorsque le DOM est modifi√© (par exemple, quand une modale est inject√©e)
    const observer = new MutationObserver(function() {
        // Ex√©cuter notre correction
        forceButtonsCorrection();
    });

    // Observer les modifications du DOM
    observer.observe(document.body, { childList: true, subtree: true });

    // Ex√©cuter aussi p√©riodiquement pour s'assurer que les boutons restent corrects
    setInterval(forceButtonsCorrection, 500);

    // Et au chargement initial
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(forceButtonsCorrection, 100);
    });

    // Ex√©cuter imm√©diatement aussi
    forceButtonsCorrection();
    </script>
</body>
</html>